@namespace RR.Blazor.Components

<div class="accordion__item @GetItemClasses()" @attributes="AdditionalAttributes">
    <button type="button" 
            class="accordion__header @(Disabled ? "accordion__header--disabled" : "")"
            @onclick="ToggleExpanded"
            disabled="@Disabled"
            aria-expanded="@(isExpanded ? "true" : "false")"
            aria-controls="@contentId">
        
        @if (Parent.IconPosition == AccordionIconPosition.Left)
        {
            <span class="accordion__icon material-symbols-rounded">
                @(isExpanded ? Parent.CollapseIcon : Parent.ExpandIcon)
            </span>
        }
        
        <div class="accordion__header-content">
            @if (!string.IsNullOrEmpty(Icon))
            {
                <i class="material-symbols-rounded accordion__header-icon">@Icon</i>
            }
            
            <span class="accordion__title">@Title</span>
            
            @if (!string.IsNullOrEmpty(Subtitle))
            {
                <span class="accordion__subtitle">@Subtitle</span>
            }
            
            @if (HeaderContent != null)
            {
                @HeaderContent
            }
        </div>
        
        @if (Parent.IconPosition == AccordionIconPosition.Right)
        {
            <span class="accordion__icon material-symbols-rounded">
                @(isExpanded ? Parent.CollapseIcon : Parent.ExpandIcon)
            </span>
        }
    </button>
    
    <div id="@contentId" 
         class="accordion__collapse @(isExpanded ? "accordion__collapse--expanded" : "")">
        <div class="accordion__body">
            @ChildContent
        </div>
    </div>
</div>

@code {
    /// <summary>Accordion item title</summary>
    [Parameter] public string Title { get; set; }
    
    /// <summary>Accordion item subtitle</summary>
    [Parameter] public string Subtitle { get; set; }
    
    /// <summary>Icon to display in header</summary>
    [Parameter] public string Icon { get; set; }
    
    /// <summary>Whether the item is expanded initially</summary>
    [Parameter] public bool Expanded { get; set; }
    
    /// <summary>Whether the item is disabled</summary>
    [Parameter] public bool Disabled { get; set; }
    
    /// <summary>Unique identifier for the item</summary>
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();
    
    /// <summary>Additional header content</summary>
    [Parameter] public RenderFragment HeaderContent { get; set; }
    
    /// <summary>Item content</summary>
    [Parameter] public RenderFragment ChildContent { get; set; }
    
    /// <summary>Additional CSS classes</summary>
    [Parameter] public string Class { get; set; }
    
    /// <summary>Additional HTML attributes</summary>
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object> AdditionalAttributes { get; set; }
    
    /// <summary>Parent accordion (cascaded)</summary>
    [CascadingParameter] private RAccordion Parent { get; set; }
    
    private bool isExpanded;
    private string contentId => $"accordion-content-{Id}";
    
    protected override void OnInitialized()
    {
        if (Parent == null)
        {
            throw new InvalidOperationException("RAccordionItem must be used inside an RAccordion component");
        }
        
        isExpanded = Expanded;
    }
    
    protected override void OnParametersSet()
    {
        isExpanded = Parent?.IsExpanded(Id) ?? false;
    }
    
    private async Task ToggleExpanded()
    {
        if (Disabled) return;
        
        await Parent.ToggleItem(Id);
        isExpanded = Parent.IsExpanded(Id);
    }
    
    private string GetItemClasses()
    {
        var classes = new List<string>();
        
        if (isExpanded)
        {
            classes.Add("accordion__item--expanded");
        }
        
        if (Disabled)
        {
            classes.Add("accordion__item--disabled");
        }
        
        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }
        
        return string.Join(" ", classes);
    }
}

@* Usage Examples:

<!-- Basic item -->
<RAccordionItem Title="Simple Item">
    This is the content of the accordion item.
</RAccordionItem>

<!-- With icon and subtitle -->
<RAccordionItem Title="Advanced Item" 
                Icon="settings" 
                Subtitle="Configure your preferences">
    Advanced content here
</RAccordionItem>

<!-- Initially expanded -->
<RAccordionItem Title="Expanded by Default" Expanded="true">
    This item starts expanded
</RAccordionItem>

<!-- Disabled item -->
<RAccordionItem Title="Disabled Item" Disabled="true">
    This content cannot be accessed
</RAccordionItem>
*@