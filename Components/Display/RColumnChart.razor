@* RColumnChart - Specialized column/bar chart component for categorical data visualization *@
@using RR.Blazor.Enums
@using RR.Blazor.Models
@using RR.Blazor.Components.Base
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using RR.Blazor.Extensions
@inherits RInteractiveComponentBase
@inject IJSRuntime JSRuntime

<RChart Title="@Title" 
        Subtitle="@Subtitle"
        Icon="@Icon"
        Type="@(IsHorizontal ? ChartType.Bar : ChartType.Column)"
        Size="@Size"
        Variant="@Variant"
        Theme="@Theme"
        Loading="@Loading"
        HasError="@HasError"
        IsEmpty="@IsEmpty"
        ShowLegend="@ShowLegend"
        LegendPosition="@LegendPosition"
        Class="@Class"
        OnClick="@OnClick"
        OnChartInit="@HandleChartInit"
        Configuration="@Configuration">
    
    <HeaderContent>
        @HeaderContent
    </HeaderContent>
    
    <ChildContent>
        <div class="column-chart-container @(IsHorizontal ? "column-chart-horizontal" : "")" @ref="chartContainer" style="height: @Height;">
            @if (Data != null && Data.Any())
            {
                var maxValue = Data.Max(d => d.Value);
                var minValue = ShowZeroLine ? 0 : Data.Min(d => d.Value);
                var range = maxValue - minValue;
                if (range == 0) range = 1; // Prevent division by zero
                
                @* Y-axis labels positioned outside in left grid area *@
                @if (ShowGridLabels && !IsHorizontal)
                {
                    <div class="column-chart-y-axis-labels">
                        @for (int i = GridLineCount; i >= 0; i--)
                        {
                            var gridValue = minValue + (range * i / GridLineCount);
                            <div class="label">@GetFormattedHumanValue(gridValue)</div>
                        }
                    </div>
                }
                
                @* Chart bars area *@
                <div class="column-chart-bars" @ref="barsContainer">
                    @* Grid lines inside chart area *@
                    @if (ShowGridLines)
                    {
                        <div class="column-chart-grid-lines">
                            @for (int i = 0; i <= GridLineCount; i++)
                            {
                                var gridPosition = i * (100.0 / GridLineCount);
                                <div class="grid-line" style="@(IsHorizontal ? $"left: {gridPosition}%" : $"bottom: {gridPosition}%")"></div>
                            }
                        </div>
                    }
                    @foreach (var (dataPoint, index) in Data.Select((d, i) => (d, i)))
                    {
                        var percentage = range > 0 ? (dataPoint.Value - minValue) / range : 0;
                        var height = Math.Max(percentage * 100, 1); // Minimum 1% height for visibility
                        var color = GetBarColor(dataPoint, index);
                        var shouldShowLabel = ShowLabels;
                        var shouldShowValue = ShowValues || selectedIndex == index;
                        
                        <div class="column-chart-bar @(selectedIndex == index ? "active" : "") @(GetBarResponsiveClass())"
                             @onclick="@(async () => await HandleBarClick(dataPoint, index))"
                             @onmouseover="@(async () => await HandleBarHover(dataPoint, index))"
                             @onmouseout="@(async () => await HandleBarLeave())"
                             role="button"
                             tabindex="0"
                             aria-label="@GetBarAriaLabel(dataPoint)">
                            
                            <div class="column-chart-bar-wrapper size-dynamic" style="--dynamic-height: @(height)%;">
                                <div class="chart-bar-dynamic column-chart-bar-fill-@GetColorVariant(dataPoint, index)"
                                     style="--bar-color: @(color); height: @(height)%;">
                                </div>
                                
                                @if (shouldShowValue)
                                {
                                    <div class="column-chart-bar-value @(hoveredIndex == index ? "visible" : "")">
                                        @GetFormattedValue(dataPoint.Value)
                                    </div>
                                }
                            </div>
                            
                        </div>
                    }
                </div>
                
                @* X-axis labels positioned in bottom grid area *@
                @if (ShowLabels && !IsHorizontal)
                {
                    <div class="column-chart-x-axis-labels">
                        @foreach (var dataPoint in Data)
                        {
                            <div class="label">@GetTruncatedLabel(dataPoint.Label)</div>
                        }
                    </div>
                }
            }
        </div>
    </ChildContent>
    
    <LegendContent>
        @if (ShowLegend && Data != null && Data.Any())
        {
            @foreach (var (dataPoint, index) in Data.Select((d, i) => (d, i)))
            {
                var color = GetBarColor(dataPoint, index);
                
                <div class="chart-legend-item @(selectedIndex == index ? "active" : "")"
                     @onclick="@(async () => await HandleLegendClick(dataPoint, index))"
                     role="button"
                     tabindex="0"
                     aria-label="@GetLegendAriaLabel(dataPoint)">
                    <div class="chart-legend-indicator" 
                         style="--legend-color: @(color);"></div>
                    <span class="chart-legend-label">@dataPoint.Label</span>
                    @if (ShowLegendValues)
                    {
                        <span class="chart-legend-label ml-auto">
                            @GetFormattedValue(dataPoint.Value)
                        </span>
                    }
                </div>
            }
        }
    </LegendContent>
    
    <FooterContent>
        @FooterContent
    </FooterContent>
    
    <AccessibilityContent>
        @if (Configuration.EnableAccessibility)
        {
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="text-left">Category</th>
                        <th class="text-right">Value</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Data != null)
                    {
                        @foreach (var dataPoint in Data)
                        {
                            <tr>
                                <td>@dataPoint.Label</td>
                                <td class="text-right">@GetFormattedValue(dataPoint.Value)</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
        @AccessibilityContent
    </AccessibilityContent>
</RChart>

@code {
    /// <summary>Column chart data points</summary>
    [Parameter] 
    [AIParameter("Array of data points for column chart", Example = "new[] { new ChartDataPoint { Label = \"Q1\", Value = 150 } }")] 
    public IEnumerable<ChartDataPoint> Data { get; set; } = new List<ChartDataPoint>();
    
    /// <summary>Chart title</summary>
    [Parameter] public string Title { get; set; }
    
    /// <summary>Chart subtitle</summary>
    [Parameter] public string Subtitle { get; set; }
    
    /// <summary>Chart icon</summary>
    [Parameter] public string Icon { get; set; } = "bar_chart";
    
    /// <summary>Chart size</summary>
    [Parameter] public ChartSize Size { get; set; } = ChartSize.Medium;
    
    /// <summary>Chart variant</summary>
    [Parameter] public ChartVariant Variant { get; set; } = ChartVariant.Default;
    
    /// <summary>Chart theme</summary>
    [Parameter] public ChartTheme Theme { get; set; } = ChartTheme.Auto;
    
    /// <summary>Whether to render as horizontal bar chart</summary>
    [Parameter] public bool IsHorizontal { get; set; }
    
    /// <summary>Whether to show bar values</summary>
    [Parameter] public bool ShowValues { get; set; } = true;
    
    /// <summary>Whether to show bar labels</summary>
    [Parameter] public bool ShowLabels { get; set; } = true;
    
    /// <summary>Whether to show axis lines</summary>
    [Parameter] public bool ShowAxis { get; set; } = true;
    
    /// <summary>Whether to show grid lines</summary>
    [Parameter] public bool ShowGridLines { get; set; } = true;
    
    /// <summary>Whether to show grid labels</summary>
    [Parameter] public bool ShowGridLabels { get; set; } = true;
    
    /// <summary>Number of grid lines</summary>
    [Parameter] public int GridLineCount { get; set; } = 5;
    
    /// <summary>Whether to show zero line</summary>
    [Parameter] public bool ShowZeroLine { get; set; } = true;
    
    /// <summary>Whether to show legend</summary>
    [Parameter] public bool ShowLegend { get; set; } = true;
    
    /// <summary>Legend position</summary>
    [Parameter] public ChartLegendPosition LegendPosition { get; set; } = ChartLegendPosition.Bottom;
    
    /// <summary>Whether to show values in legend</summary>
    [Parameter] public bool ShowLegendValues { get; set; } = true;
    
    /// <summary>Color palette for bars</summary>
    [Parameter] public string[] ColorPalette { get; set; } = DefaultColorPalette;
    
    /// <summary>Value format string</summary>
    [Parameter] public string ValueFormat { get; set; } = "N0";
    
    /// <summary>Use human-readable number formatting (950K, 1.2M, etc)</summary>
    [Parameter] public bool UseHumanReadableNumbers { get; set; } = true;
    
    /// <summary>Bar spacing (0-1)</summary>
    [Parameter] public double BarSpacing { get; set; } = 0.1;
    
    /// <summary>Chart height (CSS value)</summary>
    [Parameter] public string Height { get; set; } = "300px";
    
    /// <summary>Whether chart has error</summary>
    [Parameter] public bool HasError { get; set; }
    
    /// <summary>Whether chart is empty</summary>
    [Parameter] public bool IsEmpty { get; set; }
    
    /// <summary>Chart configuration</summary>
    [Parameter] public ChartConfiguration Configuration { get; set; } = new();
    
    /// <summary>Header content</summary>
    [Parameter] public RenderFragment HeaderContent { get; set; }
    
    /// <summary>Footer content</summary>
    [Parameter] public RenderFragment FooterContent { get; set; }
    
    /// <summary>Legend content</summary>
    [Parameter] public RenderFragment LegendContent { get; set; }
    
    /// <summary>Accessibility content</summary>
    [Parameter] public RenderFragment AccessibilityContent { get; set; }
    
    
    /// <summary>Bar click handler</summary>
    [Parameter] public EventCallback<ChartEventArgs> OnBarClick { get; set; }
    
    /// <summary>Bar hover handler</summary>
    [Parameter] public EventCallback<ChartEventArgs> OnBarHover { get; set; }

    private static readonly string[] DefaultColorPalette = {
        "var(--color-primary)",
        "var(--color-success)",
        "var(--color-warning)",
        "var(--color-error)",
        "var(--color-info)",
        "var(--color-primary-hover)",
        "var(--color-primary-active)",
        "var(--color-text-muted)"
    };

    private ElementReference chartContainer;
    private ElementReference barsContainer;
    private int selectedIndex = -1;
    private int hoveredIndex = -1;
    private IJSObjectReference chartModule;

    private async Task HandleChartInit(ElementReference element)
    {
        chartContainer = element;
        
        try
        {
            chartModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "RRBlazor.Chart.initializeChart", 
                element,
                new { responsive = true, animation = Configuration.EnableAnimation });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart init error: {ex.Message}");
        }
    }
    

    private async Task HandleBarClick(ChartDataPoint dataPoint, int index)
    {
        selectedIndex = selectedIndex == index ? -1 : index;
        
        if (OnBarClick.HasDelegate)
        {
            await OnBarClick.InvokeAsync(new ChartEventArgs
            {
                DataPoint = dataPoint,
                Index = index,
                EventType = "click"
            });
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleBarHover(ChartDataPoint dataPoint, int index)
    {
        hoveredIndex = index;
        
        if (OnBarHover.HasDelegate)
        {
            await OnBarHover.InvokeAsync(new ChartEventArgs
            {
                DataPoint = dataPoint,
                Index = index,
                EventType = "hover"
            });
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleBarLeave()
    {
        hoveredIndex = -1;
        
        if (OnBarHover.HasDelegate)
        {
            await OnBarHover.InvokeAsync(new ChartEventArgs
            {
                EventType = "leave"
            });
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleLegendClick(ChartDataPoint dataPoint, int index)
    {
        await HandleBarClick(dataPoint, index);
    }

    private string GetBarColor(ChartDataPoint dataPoint, int index)
    {
        if (!string.IsNullOrEmpty(dataPoint.Color))
        {
            return dataPoint.Color;
        }
        
        return ColorPalette[index % ColorPalette.Length];
    }

    private string GetColorVariant(ChartDataPoint dataPoint, int index)
    {
        if (!string.IsNullOrEmpty(dataPoint.Color))
        {
            return "custom";
        }
        
        return (index % ColorPalette.Length) switch
        {
            0 => "primary",
            1 => "success",
            2 => "warning",
            3 => "error",
            4 => "info",
            5 => "primary-hover",
            6 => "primary-active",
            7 => "muted",
            _ => "primary"
        };
    }

    private string GetBarWrapperStyle(double heightPercentage)
    {
        if (IsHorizontal)
        {
            return $"width: {heightPercentage}%; height: 100%;";
        }
        else
        {
            return $"height: {heightPercentage}%; width: 100%; position: relative; display: flex; flex-direction: column; justify-content: flex-end;";
        }
    }
    
    private string GetBarFillStyle(string color)
    {
        return $"background: {color}; width: 100%; height: 100%; border-radius: var(--radius-sm) var(--radius-sm) 0 0; transition: all var(--duration-fast) var(--ease-out);";
    }
    
    private string GetBarResponsiveClass()
    {
        var dataCount = Data?.Count() ?? 0;
        if (dataCount > 50) return "column-chart-bar-dense";
        if (dataCount > 30) return "column-chart-bar-compact";
        if (dataCount > 15) return "column-chart-bar-normal";
        return "column-chart-bar-spacious";
    }
    
    
    private string GetTruncatedLabel(string label)
    {
        if (string.IsNullOrEmpty(label)) return "";
        
        var dataCount = Data?.Count() ?? 0;
        var maxLength = dataCount > 30 ? 5 : dataCount > 15 ? 8 : 12;
        
        return label.Length > maxLength ? $"{label.Substring(0, maxLength)}..." : label;
    }

    private string GetFormattedValue(double value)
    {
        return value.ToString(ValueFormat);
    }

    private string GetFormattedHumanValue(double value)
    {
        return UseHumanReadableNumbers && value >= 1000
            ? value.ToHumanReadable(0)
            : GetFormattedValue(value);
    }

    private string GetBarAriaLabel(ChartDataPoint dataPoint)
    {
        return $"{dataPoint.Label}: {GetFormattedValue(dataPoint.Value)}";
    }

    private string GetLegendAriaLabel(ChartDataPoint dataPoint)
    {
        return $"Toggle {dataPoint.Label} bar: {GetFormattedValue(dataPoint.Value)}";
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (chartModule != null)
            {
                await chartModule.InvokeVoidAsync("dispose");
                await chartModule.DisposeAsync();
            }
        }
        catch (JSDisconnectedException)
        {
            // Expected when circuit is disconnected
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chart disposal error: {ex.Message}");
        }
    }
    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        if (firstRender && Data?.Any() == true)
        {
            await HandleChartInit(chartContainer);
        }
    }
}

@*
Usage Examples:

<!-- Basic column chart -->
<RColumnChart Title="Monthly Sales" 
              Data="@salesData" 
              Icon="bar_chart" />

<!-- Horizontal bar chart -->
<RColumnChart Title="Product Performance" 
              Data="@performanceData"
              IsHorizontal="true"
              Icon="bar_chart_4_bars" />

<!-- Column chart with custom styling -->
<RColumnChart Title="Revenue by Quarter" 
              Data="@revenueData"
              Size="ChartSize.Large"
              Variant="ChartVariant.Elevated"
              ValueFormat="C0"
              ShowGridLines="true"
              ShowGridLabels="true"
              ColorPalette="@customColors" />

<!-- Interactive column chart -->
<RColumnChart Title="User Engagement" 
              Data="@engagementData"
              OnBarClick="@HandleBarClick"
              OnBarHover="@HandleBarHover"
              ShowLegendValues="true"
              ShowValues="true" />

<!-- Minimal column chart -->
<RColumnChart Data="@simpleData"
              Variant="ChartVariant.Minimal"
              ShowLegend="false"
              ShowGridLines="false"
              ShowAxis="false" />

<!-- Column chart with header controls -->
<RColumnChart Title="Performance Metrics" 
              Data="@performanceData"
              LegendPosition="ChartLegendPosition.Top">
    
    <HeaderContent>
        <div class="d-flex gap-2">
            <button class="button button-outline button-sm">
                <i class="material-symbols-rounded mr-1">download</i>
                Export
            </button>
            <select class="form-field-input form-field-sm">
                <option>Daily</option>
                <option>Weekly</option>
                <option>Monthly</option>
            </select>
        </div>
    </HeaderContent>
    
    <FooterContent>
        <div class="d-flex justify-between text-sm text-secondary">
            <span>Average: @GetAverage()</span>
            <span>Total: @GetTotal()</span>
        </div>
    </FooterContent>
</RColumnChart>

<!-- Stacked column chart simulation -->
<RColumnChart Title="Sales by Category" 
              Data="@stackedData"
              ShowValues="false"
              ShowLabels="true"
              BarSpacing="0.2">
    
    <HeaderContent>
        <div class="chart-legend chart-legend-top">
            <div class="chart-legend-item">
                <div class="chart-legend-indicator bg-success"></div>
                <span class="chart-legend-label">Category A</span>
            </div>
            <div class="chart-legend-item">
                <div class="chart-legend-indicator bg-warning"></div>
                <span class="chart-legend-label">Category B</span>
            </div>
        </div>
    </HeaderContent>
</RColumnChart>

<!-- Accessible column chart -->
<RColumnChart Title="Budget Allocation" 
              Data="@budgetData"
              Configuration="@(new ChartConfiguration { EnableAccessibility = true })"
              ShowAccessibilityTable="true"
              ShowGridLabels="true" />

@code {
    private List<ChartDataPoint> salesData = new()
    {
        new ChartDataPoint { Label = "Jan", Value = 150 },
        new ChartDataPoint { Label = "Feb", Value = 230 },
        new ChartDataPoint { Label = "Mar", Value = 180 },
        new ChartDataPoint { Label = "Apr", Value = 270 },
        new ChartDataPoint { Label = "May", Value = 320 }
    };

    private string[] customColors = {
        "var(--color-primary)", "var(--color-success)", "var(--color-warning)", "var(--color-error)", "var(--color-info)"
    };

    private async Task HandleBarClick(ChartEventArgs args)
    {


    }

    private async Task HandleBarHover(ChartEventArgs args)
    {

        if (args.EventType == "hover")
        {

        }
    }

    private string GetAverage()
    {
        return salesData.Average(d => d.Value).ToString("N0");
    }

    private string GetTotal()
    {
        return salesData.Sum(d => d.Value).ToString("N0");
    }
}
*@