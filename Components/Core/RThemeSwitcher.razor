@using RR.Blazor.Services
@using RR.Blazor.Models
@implements IDisposable
@inject IThemeService ThemeService

<button class="d-inline-flex align-center justify-center clickable border-light bg-elevated text-secondary hover:bg-primary hover:text-inverse rounded-lg transition-fast"
        style="width: 40px; height: 40px; padding: 0;" 
        @onclick="ToggleTheme" 
        title="@GetTooltip()"
        aria-label="@GetTooltip()">
    <i class="material-symbols-rounded">@GetThemeIcon()</i>
</button>

@code {
    [Parameter] public string Class { get; set; } = "";
    [Parameter] public string Style { get; set; } = "";
    
    private ThemeMode currentMode = ThemeMode.Light;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentMode = await ThemeService.GetThemeModeAsync();
            ThemeService.ThemeChanged += OnThemeChanged;
            Console.WriteLine($"RThemeSwitcher initialized with mode: {currentMode}");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to initialize theme switcher: {ex.Message}");
            currentMode = ThemeMode.Light;
        }
    }

    private void OnThemeChanged(ThemeConfiguration theme)
    {
        InvokeAsync(() =>
        {
            currentMode = theme.Mode;
            StateHasChanged();
        });
    }

    private async Task ToggleTheme()
    {
        try
        {
            Console.WriteLine($"RThemeSwitcher: Toggle clicked, current mode: {currentMode}");
            
            var newMode = currentMode switch
            {
                ThemeMode.Light => ThemeMode.Dark,
                ThemeMode.Dark => ThemeMode.System,
                ThemeMode.System => ThemeMode.Light,
                _ => ThemeMode.Light
            };
            
            Console.WriteLine($"RThemeSwitcher: Switching from {currentMode} to {newMode}");
            currentMode = newMode;
            
            await ThemeService.SetThemeModeAsync(currentMode);
            Console.WriteLine($"RThemeSwitcher: Theme service updated to {currentMode}");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to toggle theme: {ex.Message}");
        }
    }

    private string GetThemeIcon()
    {
        return currentMode switch
        {
            ThemeMode.Light => "light_mode",
            ThemeMode.Dark => "dark_mode", 
            ThemeMode.System => "contrast",
            _ => "light_mode"
        };
    }

    private string GetTooltip()
    {
        return currentMode switch
        {
            ThemeMode.Light => "Switch to dark theme",
            ThemeMode.Dark => "Switch to system theme",
            ThemeMode.System => "Switch to light theme", 
            _ => "Switch theme"
        };
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

