@using RR.Blazor.Models
@using RR.Blazor.Services
@using RR.Blazor.Enums
@using Microsoft.AspNetCore.Components.Web
@implements IDisposable
@inject IModalService ModalService
@inject IJSRuntime JSRuntime

@* RModalProvider - JavaScript DOM repositioning system for framework integration *@
@* Stays in RAppShell as required - JavaScript portals move modals to body level *@
<div class="modal-provider @(_activeModals.Any() ? "active" : "")" 
     @onkeydown="OnKeyDownHandler" 
     @onkeydown:preventDefault="false" 
     tabindex="-1"
     style="@GetProviderStyles()">
    @foreach (var modal in _activeModals)
    {
        <RModal 
            @key="modal.Id"
            Visible="@modal.Visible"
            Text="@modal.Options.Title"
            Subtitle="@modal.Options.Subtitle"
            Icon="@modal.Options.Icon"
            Size="@modal.Options.Size"
            Variant="@modal.Options.Variant"
            CloseOnBackdrop="@modal.Options.CloseOnBackdrop"
            CloseOnEscape="@modal.Options.CloseOnEscape"
            ShowCloseButton="@modal.Options.ShowCloseButton"
            ShowHeader="@modal.Options.ShowHeader"
            ShowFooter="@modal.Options.ShowFooter"
            Class="@modal.Options.Class"
            OnClose="@(() => HandleModalClose(modal))"
            OnCancel="@(() => HandleModalCancel(modal))"
            OnPrimaryAction="@(() => HandlePrimaryAction(modal))"
            FooterContent="@(modal.Options.Buttons.Any() ? CreateModalFooter(modal) : null)">
            
            @if (modal.Options.ComponentType != null)
            {
                <DynamicComponent Type="modal.Options.ComponentType" Parameters="GetComponentParameters(modal)" />
            }
        </RModal>
    }
</div>

@code {
    private readonly List<ModalInstance> _activeModals = new();
    private DotNetObjectReference<RModalProvider> _dotNetRef;
    private IJSObjectReference _jsModule;

    protected override async Task OnInitializedAsync()
    {
        _dotNetRef = DotNetObjectReference.Create(this);
        
        ModalService.OnModalOpened += OnModalOpened;
        ModalService.OnModalClosed += OnModalClosed;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize JavaScript DOM repositioning system
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/RR.Blazor/js/modal-provider.js");
                await _jsModule.InvokeVoidAsync("initialize", _dotNetRef);
                
                Console.WriteLine("[RModalProvider] JavaScript DOM repositioning system initialized successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[RModalProvider] Failed to initialize JavaScript module: {ex.Message}");
            }
        }
        
        if (_activeModals.Any())
        {
            // Focus management for keyboard handling
            await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.modal-provider.active')?.focus()");
        }
    }

    private void OnModalOpened(ModalInstance modal)
    {
        _activeModals.Add(modal);
        StateHasChanged();
    }

    private void OnModalClosed(ModalInstance modal)
    {
        _activeModals.Remove(modal);
        StateHasChanged();
    }

    private Dictionary<string, object> GetComponentParameters(ModalInstance modal)
    {
        var parameters = new Dictionary<string, object>();
        
        foreach (var param in modal.Options.Parameters)
        {
            parameters[param.Key] = param.Value;
        }
        
        if (modal.Options.Data != null)
        {
            parameters["Data"] = modal.Options.Data;
        }

        parameters["OnDataChanged"] = EventCallback.Factory.Create<object>(this, data =>
        {
            modal.Result = data;
            StateHasChanged();
        });

        return parameters;
    }

    private RenderFragment CreateModalFooter(ModalInstance modal)
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "modal-footer-buttons");

            var index = 2;
            foreach (var button in modal.Options.Buttons)
            {
                builder.OpenComponent(index++, typeof(RButton));
                builder.AddAttribute(index++, "Text", button.Text);
                builder.AddAttribute(index++, "Variant", button.Variant);
                builder.AddAttribute(index++, "Icon", button.Icon);
                builder.AddAttribute(index++, "IconPosition", IconPosition.Start);
                builder.AddAttribute(index++, "Class", button.Class);
                builder.AddAttribute(index++, "Disabled", button.IsDisabled);
                builder.AddAttribute(index++, "Loading", button.IsLoading);
                builder.AddAttribute(index++, "OnClick", EventCallback.Factory.Create(this, async () =>
                {
                    await HandleButtonClick(modal, button);
                }));
                builder.CloseComponent();
            }

            builder.CloseElement();
        };
    }

    private async Task HandleModalClose(ModalInstance modal)
    {
        await CloseModal(modal, Enums.ModalResult.Cancel);
    }

    private async Task HandleModalCancel(ModalInstance modal)
    {
        await CloseModal(modal, Enums.ModalResult.Cancel);
    }

    private async Task HandlePrimaryAction(ModalInstance modal)
    {
        var primaryButton = modal.Options.Buttons.FirstOrDefault(b => b.Type == ModalButtonType.Primary);
        if (primaryButton?.OnClick != null)
        {
            var canClose = await primaryButton.OnClick(modal.Result ?? modal.Options.Data);
            if (canClose)
            {
                await CloseModal(modal, primaryButton.Result);
            }
        }
        else
        {
            await CloseModal(modal, Enums.ModalResult.Ok);
        }
    }

    private async Task HandleButtonClick(ModalInstance modal, ModalButton button)
    {
        if (button.OnClick != null)
        {
            var canClose = await button.OnClick(modal.Result ?? modal.Options.Data);
            if (canClose)
            {
                await CloseModal(modal, button.Result);
            }
        }
        else
        {
            await CloseModal(modal, button.Result);
        }
    }

    private async Task CloseModal(ModalInstance modal, Enums.ModalResult result)
    {
        modal.Visible = false;
        
        if (modal is ModalInstance<object> typedModal)
        {
            typedModal.TaskSource.SetResult(new ModalResult<object>
            {
                ResultType = result,
                Data = modal.Result
            });
        }

        await ModalService.CloseAsync(modal.Id);
    }

    private string GetSizeString(ModalSize size) => size switch
    {
        ModalSize.Small => "small",
        ModalSize.Large => "large",
        ModalSize.XLarge => "xlarge",
        ModalSize.Wide => "wide",
        ModalSize.Full => "full",
        _ => "medium"
    };

    private string GetVariantString(ModalVariant variant) => variant switch
    {
        ModalVariant.Confirmation => "confirmation",
        ModalVariant.Destructive => "destructive",
        ModalVariant.Success => "success",
        ModalVariant.Warning => "warning",
        ModalVariant.Info => "info",
        ModalVariant.Glass => "glass",
        ModalVariant.Protected => "protected",
        _ => "default"
    };

    private async Task OnKeyDownHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && _activeModals.Any())
        {
            var topModal = _activeModals.LastOrDefault();
            if (topModal?.Options.CloseOnEscape == true)
            {
                await HandleModalClose(topModal);
            }
        }
    }

    [JSInvokable]
    public async Task OnKeyDown(string key)
    {
        // Legacy method for backwards compatibility
        if (key == "Escape" && _activeModals.Any())
        {
            var topModal = _activeModals.LastOrDefault();
            if (topModal?.Options.CloseOnEscape == true)
            {
                await HandleModalClose(topModal);
            }
        }
    }


    private string GetProviderStyles()
    {
        // Provide base positioning that JavaScript will enhance
        var styles = new List<string>
        {
            "position: fixed",
            "inset: 0",
            "z-index: var(--z-modal-container, 1045)"
        };
        
        if (_activeModals.Any())
        {
            styles.Add("pointer-events: auto");
        }
        else
        {
            styles.Add("pointer-events: none");
        }
        
        return string.Join("; ", styles);
    }

    public void Dispose()
    {
        ModalService.OnModalOpened -= OnModalOpened;
        ModalService.OnModalClosed -= OnModalClosed;
        
        try
        {
            _jsModule?.DisposeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RModalProvider] Error disposing JavaScript module: {ex.Message}");
        }
        
        _dotNetRef?.Dispose();
    }
}