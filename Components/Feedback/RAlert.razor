@** 
<summary>
Alert component for displaying important messages with different severity levels.
Supports info, success, warning, and error states with consistent styling.
</summary>
<category>Feedback</category>
<complexity>Simple</complexity>
<ai-prompt>Create alert for important messages</ai-prompt>
<ai-common-use>notifications, status messages, validation feedback</ai-common-use>
<ai-avoid>Don't use for regular content - use RCard instead</ai-avoid>
<ai-pattern name="info-alert">Type="AlertType.Info" for informational messages</ai-pattern>
<ai-pattern name="success-alert">Type="AlertType.Success" for success messages</ai-pattern>
<ai-pattern name="warning-alert">Type="AlertType.Warning" for warning messages</ai-pattern>
<ai-pattern name="error-alert">Type="AlertType.Error" for error messages</ai-pattern>
**@
@using RR.Blazor.Enums
@using RR.Blazor.Attributes
@using RR.Blazor.Components.Base
@using RR.Blazor.Utilities
@inherits RForwardingComponentBase

@attribute [Component("RAlert", Category = "Feedback", Complexity = ComponentComplexity.Simple)]
@attribute [AIOptimized(Prompt = "Create alert for messages", 
                       CommonUse = "notifications, status messages, validation feedback", 
                       AvoidUsage = "Don't use for regular content - use RCard instead")]

@if (isVisible)
{
    <div class="alert @GetAlertClasses()" 
         role="alert"
         aria-live="@(Type == AlertType.Error ? "assertive" : "polite")"
         @onclick="HandleClick"
         @onclick:stopPropagation="StopPropagation"
         @attributes="GetSafeAttributes()">
        
        @if (Dismissible)
        {
            <button class="alert-close" 
                    type="button"
                    @onclick="@(_ => Dismiss())"
                    @onclick:stopPropagation="true"
                    aria-label="Close alert">
                <i class="icon">close</i>
            </button>
        }
        
        <div class="d-flex @GetMainFlexAlignmentClasses() @GetMainWidthClass() flex-1 @GetGapClass()">
            @if (ShowIcon)
            {
                <div class="alert-icon shrink-0">
                    <i class="icon @GetIconClasses()">@GetIcon()</i>
                </div>
            }

            <div class="alert-content @GetContentFlexClass() @GetContentAlignmentClasses()">
                @if (!string.IsNullOrEmpty(Title))
                {
                    <div class="alert-title font-semibold @GetTitleClasses()">@Title</div>
                }
                
                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="alert-message @GetMessageClasses()">@Message</div>
                }
                
                @if (!string.IsNullOrEmpty(Text))
                {
                    <div class="alert-text @GetMessageClasses()">@Text</div>
                }
                
                @if (ChildContent != null)
                {
                    <div class="alert-content-custom">
                        @ChildContent
                    </div>
                }
                
                @if (Actions != null)
                {
                    <div class="alert-actions mt-3 d-flex gap-2">
                        @Actions
                    </div>
                }
            </div>
        </div>
    </div>
}

@implements IDisposable
@code {
    private bool isVisible = true;
    private Timer? autoCloseTimer;
    private bool disposed = false;
    
    /// <summary>Alert type</summary>
    [Parameter, AIParameter("Alert severity level", "AlertType.Info, AlertType.Success, AlertType.Warning, AlertType.Error")] 
    public AlertType Type { get; set; } = AlertType.Info;
    
    /// <summary>Alert variant style</summary>
    [Parameter, AIParameter("Alert visual variant", "VariantType.Default, VariantType.Primary, VariantType.Secondary, VariantType.Secondary")] 
    public VariantType Variant { get; set; } = VariantType.Default;
    
    /// <summary>Whether to use filled background style</summary>
    [Parameter, AIParameter("Use filled background", "true for solid background color")] 
    public bool Filled { get; set; } = false;
    
    /// <summary>Alert size</summary>
    [Parameter, AIParameter("Alert size", "SizeType.Small, SizeType.Medium, SizeType.Large")] 
    public SizeType Size { get; set; } = SizeType.Medium;
    
    
    /// <summary>Content alignment</summary>
    [Parameter, AIParameter("Content alignment within alert", "AlertContentAlignment.Start, AlertContentAlignment.Center, AlertContentAlignment.End")] 
    public AlertContentAlignment ContentAlignment { get; set; } = AlertContentAlignment.Start;
    
    /// <summary>Alert title</summary>
    [Parameter, AIParameter("Alert title text", "Main heading for the alert")] 
    public string Title { get; set; }
    
    /// <summary>Alert text</summary>
    [Parameter, AIParameter("Alert message text", "Main message content")] 
    public string Text { get; set; }
    
    /// <summary>Alert message (alias for Text)</summary>
    [Parameter, AIParameter("Alert message content", "Clear, actionable message explaining the alert")] 
    public string Message { get; set; }
    
    /// <summary>Custom icon override</summary>
    [Parameter, AIParameter("Custom icon", "Material icon name to override default")] 
    public string Icon { get; set; }
    
    /// <summary>Whether to show icon</summary>
    [Parameter] public bool ShowIcon { get; set; } = true;
    
    /// <summary>Whether alert can be dismissed</summary>
    [Parameter, AIParameter("Show close button", "true to allow dismissing the alert")] 
    public bool Dismissible { get; set; }
    
    /// <summary>Auto-close timeout in milliseconds (0 = disabled)</summary>
    [Parameter] public int AutoCloseTimeout { get; set; } = 0;
    
    /// <summary>Whether alert should animate</summary>
    [Parameter] public bool Animated { get; set; } = true;
    
    
    /// <summary>Whether alert should be elevated</summary>
    [Parameter] public bool Elevated { get; set; } = false;
    
    /// <summary>Stop click propagation</summary>
    [Parameter] public bool StopPropagation { get; set; } = false;
    
    
    
    /// <summary>Action buttons content</summary>
    [Parameter] public RenderFragment Actions { get; set; }
    
    /// <summary>Dismiss event</summary>
    [Parameter] public EventCallback OnDismiss { get; set; }
    
    /// <summary>Click event handler</summary>
    [Parameter] public EventCallback<MouseEventArgs> OnClick { get; set; }
    
    
    protected override void OnInitialized()
    {
        if (AutoCloseTimeout > 0)
        {
            autoCloseTimer = new Timer(async _ =>
            {
                if (!disposed) await Dismiss();
            }, null, AutoCloseTimeout, Timeout.Infinite);
        }
    }
    
    private string GetAlertClasses()
    {
        var classes = new List<string>
        {
            "position-relative",
            "d-flex",
            "items-start",
            "border",
            "rounded-lg",
            "transition-all",
            "duration-200"
        };
        

        classes.Add(GetDensityClasses());
        
        classes.Add(Size switch
        {
            SizeType.Small => "alert-sm",
            SizeType.Large => "alert-lg",
            _ => "" // Medium is default, no class needed
        });
        
        string alertTypeClass = $"alert-{Type.ToString().ToLower()}";
        
        if (Filled)
        {
            classes.Add(alertTypeClass);
            classes.Add($"bg-{Type.ToString().ToLower()}");
        }
        else if (Variant == VariantType.Secondary)
        {
            classes.Add(alertTypeClass);
            classes.Add("alert-outline");
        }
        else
        {
            classes.Add(alertTypeClass);
        }
        

        if (FullWidth)
        {
            classes.Add("w-full");
        }
        
        if (Elevated)
        {
            classes.Add("shadow-lg");
        }
        
        if (Animated)
        {
            classes.Add("animate-fade-in");
        }
        
        if (Dismissible)
        {
            classes.Add("alert-dismissible");
        }
        
        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }
        
        return string.Join(" ", classes);
    }
    
    protected override string GetDensityClasses()
    {
        return DensityHelper.BuildDensityClasses("alert", Density);
    }
    
    private string GetIcon()
    {
        if (!string.IsNullOrEmpty(Icon))
        {
            return Icon;
        }
        
        return Type switch
        {
            AlertType.Success => "check_circle",
            AlertType.Warning => "warning",
            AlertType.Error => "error",
            _ => "info"
        };
    }
    
    private string GetIconClasses()
    {
        var classes = new List<string>();
        
        classes.Add(Size switch
        {
            SizeType.Small => "text-lg",
            SizeType.Medium => "text-xl",
            SizeType.Large => "text-2xl",
            _ => "text-xl"
        });
        
        return string.Join(" ", classes);
    }
    
    private string GetTitleClasses()
    {
        var classes = new List<string>();
        
        classes.Add(Size switch
        {
            SizeType.Small => "text-sm mb-1",
            SizeType.Medium => "text-base mb-1",
            SizeType.Large => "text-lg mb-2",
            _ => "text-base mb-1"
        });
        
        return string.Join(" ", classes);
    }
    
    private string GetMessageClasses()
    {
        var classes = new List<string>();
        
        classes.Add(Size switch
        {
            SizeType.Small => "text-xs",
            SizeType.Medium => "text-sm",
            SizeType.Large => "text-base",
            _ => "text-sm"
        });
        
        return string.Join(" ", classes);
    }
    
    private string GetMainFlexAlignmentClasses()
    {
        return ContentAlignment switch
        {
            AlertContentAlignment.Center => "flex-col items-center justify-center",
            AlertContentAlignment.End => "items-center justify-end",
            _ => "items-center"
        };
    }
    
    private string GetContentAlignmentClasses()
    {
        return ContentAlignment switch
        {
            AlertContentAlignment.Center => "text-center",
            AlertContentAlignment.End => "text-end",
            _ => ""
        };
    }

    private string GetGapClass()
    {
        return ContentAlignment switch
        {
            AlertContentAlignment.Center => "gap-2",
            _ => "gap-3"
        };
    }

    private string GetContentFlexClass()
    {
        return ContentAlignment == AlertContentAlignment.Center ? "" : "flex-1";
    }

    private string GetMainWidthClass()
    {
        // When FullWidth is true and content is centered, ensure the main wrapper takes full width
        return (FullWidth && ContentAlignment == AlertContentAlignment.Center) ? "w-full" : "";
    }


    private async Task Dismiss()
    {
        if (disposed) return;
        
        isVisible = false;
        await OnDismiss.InvokeAsync();
        StateHasChanged();
    }
    
    private async Task HandleClick(MouseEventArgs e)
    {
        if (OnClick.HasDelegate)
            await OnClick.InvokeAsync(e);
    }
    
    private async Task HandleDismiss()
    {
        await Dismiss();
    }
    
    public void Dispose()
    {
        if (disposed) return;
        disposed = true;
        
        autoCloseTimer?.Dispose();
        autoCloseTimer = null;
        
    }
}
