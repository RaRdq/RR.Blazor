@use '../abstracts' as *;

.dropdown {
  position: relative;
  
  &-trigger {
    background: var(--color-surface-elevated);
    border: var(--border-1) solid var(--color-border);
    border-radius: var(--radius-lg);
    margin: 0;
    padding: var(--space-3) var(--space-4);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    width: 100%;
    text-align: left;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(8px);
    
    // Ultra PRO glassmorphism effect
    @supports (backdrop-filter: blur(var(--blur-md))) {
      background: color-mix(in srgb, var(--color-surface-elevated) 85%, transparent);
      border-color: color-mix(in srgb, var(--color-border) 60%, transparent);
    }
    
    // Add dropdown indicator with enhanced styling
    &::after {
      content: 'expand_more';
      font-family: 'Material Symbols Rounded';
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      transition: all var(--duration-fast) var(--ease-out);
      font-size: var(--icon-base);
      color: var(--color-text-muted);
      opacity: 0.8;
    }
    
    &-open::after {
      transform: translateY(-50%) rotate(180deg);
    }
    
    &:hover:not(:disabled) {
      border-color: var(--color-border);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px) scale(1.01);
      
      &::after {
        opacity: 1;
        color: var(--color-text);
      }
    }
    
    &:focus:not(:disabled) {
      outline: var(--border-2) solid var(--color-primary);
      outline-offset: var(--border-1);
      border-color: var(--color-primary);
    }
    
    &:disabled {
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
      
      &:hover {
        transform: none;
        box-shadow: none;
        border-color: var(--color-border);
      }
    }
  }
  
  &-viewport {
    position: absolute;
    left: 0;
    right: 0;
    z-index: var(--z-dropdown);
    
    // Ensure dropdown viewport creates new stacking context
    transform: translateZ(0);
    will-change: transform;
  }
  
  &-content {
    background: var(--color-surface-elevated);
    border: var(--border-1) solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl);
    backdrop-filter: blur(20px);
    min-width: 16rem;
    max-width: min(320px, 90vw);
    max-height: min(320px, 50vh);
    overflow-y: auto;
    width: max-content;
    animation: dropdownSlideIn var(--duration-normal) var(--ease-out);
    padding: var(--space-2) 0;
    position: relative;
    z-index: var(--z-dropdown);
    
    // Force proper stacking context
    transform: translateZ(0);
    isolation: isolate;
    
    // Ultra PRO glassmorphism effect with enhanced transparency
    @supports (backdrop-filter: blur(var(--blur-xl))) {
      background: color-mix(in srgb, var(--color-surface-elevated) 92%, transparent);
      border-color: color-mix(in srgb, var(--color-border) 50%, transparent);
    }
    
    // Custom scrollbar
    &::-webkit-scrollbar {
      width: var(--space-1);
    }
    
    &::-webkit-scrollbar-track {
      background: transparent;
    }
    
    &::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: var(--radius-sm);
      
      &:hover {
        background: var(--color-border);
      }
    }
  }
  
  // Animation for top positions
  &-top &-content,
  &-topend &-content,
  &-topstart &-content,
  &-position-above &-content {
    animation: dropdownSlideUp var(--duration-normal) var(--ease-out);
  }
  
  // Animation for bottom positions
  &-position-below &-content {
    animation: dropdownSlideIn var(--duration-normal) var(--ease-out);
  }
  
  // BOTTOM positioning - below trigger (default)
  &-bottom {
    .dropdown-viewport {
      top: calc(100% + #{var(--space-2)});
    }
  }
  
  // TOP positioning - above trigger
  &-top {
    .dropdown-viewport {
      bottom: calc(100% + #{var(--space-2)});
      top: auto;
    }
  }
  
  // TOP END positioning - above trigger, aligned to end
  &-topend {
    .dropdown-viewport {
      bottom: calc(100% + #{var(--space-2)});
      top: auto;
      left: auto;
      right: 0;
    }
  }
  
  // TOP START positioning - above trigger, aligned to start
  &-topstart {
    .dropdown-viewport {
      bottom: calc(100% + #{var(--space-2)});
      top: auto;
      left: 0;
      right: auto;
    }
  }
  
  // BOTTOM END positioning - below trigger, aligned to end
  &-bottomend {
    .dropdown-viewport {
      top: calc(100% + #{var(--space-2)});
      left: auto;
      right: 0;
    }
  }
  
  // BOTTOM START positioning - below trigger, aligned to start
  &-bottomstart {
    .dropdown-viewport {
      top: calc(100% + #{var(--space-2)});
      left: 0;
      right: auto;
    }
  }
  
  // AUTO positioning - CSS-only smart positioning  
  &-auto {
    .dropdown-viewport {
      // Default: position below
      top: calc(100% + #{var(--space-2)});
      
      // Simple viewport detection: if trigger is in bottom 40% of screen, show above
      @media (max-height: 800px) {
        top: calc(-250px - #{var(--space-3)});
      }
      
      // For very small screens, always show above
      @media (max-height: 600px) {
        top: calc(-200px - #{var(--space-3)});
      }
    }
  }
  
  &-header,
  &-footer {
    padding: var(--space-2) var(--space-3);
    background: var(--color-surface);
    border-bottom: var(--border-1) solid var(--color-border);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  &-footer {
    border-bottom: none;
    border-top: var(--border-1) solid var(--color-border);
  }
  
  &-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }
  
  &-item {
    background: none;
    border: none;
    margin: var(--space-1) var(--space-2);
    padding: var(--space-3) var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    width: calc(100% - var(--space-4));
    text-align: left;
    color: var(--color-text);
    transition: all var(--duration-fast) var(--ease-out);
    cursor: pointer;
    position: relative;
    border-radius: var(--radius-md);
    
    // Icon styling
    > i {
      font-size: var(--icon-sm);
      width: var(--icon-sm);
      flex-shrink: 0;
    }
    
    // Text styling
    span {
      flex: 1;
      font-size: var(--text-sm);
      font-weight: var(--font-normal);
      line-height: 1.4;
    }
    
    &:hover:not(&-disabled) {
      background: var(--color-primary-light);
      color: var(--color-text);
      transform: translateX(2px) scale(1.02);
      box-shadow: var(--shadow-sm);
    }
  &-active {
      background: var(--color-primary-medium);
      color: var(--color-primary);
      font-weight: var(--font-medium);
      box-shadow: var(--shadow-sm);
      border: var(--border-1) solid var(--color-primary);
      
      // Remove the bulky left indicator
      &::before {
        display: none;
      }
      
      &:hover {
        background: var(--color-primary-medium);
        transform: translateX(2px) scale(1.02);
        box-shadow: var(--shadow-md);
      }
    }
  &-disabled {
      opacity: var(--opacity-disabled);
      cursor: not-allowed;
      
      &:hover {
        background: none;
        color: var(--color-text-muted);
      }
    }
    
    // Check icon alignment
    > i:last-child {
      margin-left: auto;
      opacity: var(--opacity-medium);
    }
  }
  
  &-separator {
    height: var(--border-1);
    background: var(--color-border);
    margin: var(--space-2) 0;
  }
}

// Backdrop for dropdown outside click detection
.dropdown-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: calc(var(--z-dropdown) - 1);
  background: transparent;
  cursor: default;
}

// Global dropdown container fix - ensure all dropdowns appear above content
.dropdown {
  // Force new stacking context for dropdown containers
  &:has(.dropdown-viewport) {
    position: relative;
    z-index: var(--z-dropdown);
  }
  
  // Alternative selector for browsers without :has() support
  &.open,
  &[aria-expanded="true"] {
    position: relative;
    z-index: var(--z-dropdown);
  }
}

// Special handling for dropdowns in sidebar footer/constrained spaces
.app-sidebar {
  .dropdown {
    // Ensure sidebar dropdowns have higher z-index than main content
    &:has(.dropdown-viewport),
    &.open,
    &[aria-expanded="true"] {
      z-index: calc(var(--z-dropdown) + 10);
    }
    
    .dropdown-viewport {
      z-index: calc(var(--z-dropdown) + 10);
    }
    
    .dropdown-content {
      z-index: calc(var(--z-dropdown) + 10);
    }
  }
}